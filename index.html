<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>REMANANCE | Sivil Takip Sistemi</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<div id="main-wrapper">

  <!-- SOL: HARİTA -->
  <div id="map-section">
    <div id="map-container"></div>
    <div id="tooltip"></div>
  </div>

  <!-- SAĞ: PANEL -->
  <aside id="sidebar">
    <h1>Remanance</h1>

    <!-- Citizen Search -->
    <div class="panel-block">
      <h2>Vatandaş Durum Sorgulama</h2>
      <div class="input-group">
        <input id="citizen-search-input" placeholder="Citizen Code">
        <button onclick="searchCitizen()">Sorgula</button>
      </div>
      <div id="citizen-result" style="display:none; margin-top:10px;"></div>
    </div>

    <!-- City Panel -->
    <div class="panel-block" id="city-panel" style="display:none;">
      <h2 id="panel-city-name"></h2>
      <div class="stats-grid">
        <div class="stat-card">
          <small>Durum</small>
          <strong id="panel-city-status"></strong>
        </div>
        <div class="stat-card">
          <small>Sağ Kalan</small>
          <strong id="panel-city-pop"></strong>
        </div>
      </div>

      <div style="margin-top:15px;">
        <small>İlçe Durumları</small>
        <div id="district-list" class="district-list"></div>
      </div>
    </div>

    <!-- News -->
    <div class="panel-block" style="flex:1;">
      <h2>Canlı Veri Akışı</h2>
      <div id="news-feed"></div>
    </div>

  </aside>
</div>

<script src="core.js"></script>
<script>
/* ====== INIT ====== */
initDB();
loadMap();
loadNews();

/* ====== MAP ====== */
function loadMap() {
  fetch("turkey_adm1.svg")
    .then(r => r.text())
    .then(svg => {
      document.getElementById("map-container").innerHTML = svg;
      initMapEvents();
    });
}

function initMapEvents() {
  document.querySelectorAll("svg path").forEach(p => {
    const id = p.id;
    if (!id) return;

    const data = getCityData(id);
    p.classList.add(`status-${data.status}`);

    p.addEventListener("click", () => selectCity(id));
    p.addEventListener("mouseenter", e => showTooltip(e, data.name, data.status));
    p.addEventListener("mousemove", moveTooltip);
    p.addEventListener("mouseleave", hideTooltip);
  });
}

/* ====== CITY SELECT ====== */
function selectCity(id) {
  const data = getCityData(id);

  document.getElementById("city-panel").style.display = "block";
  document.getElementById("panel-city-name").innerText = data.name;
  document.getElementById("panel-city-status").innerText = STATUS_LABELS[data.status];
  document.getElementById("panel-city-pop").innerText =
    new Intl.NumberFormat("tr-TR").format(data.population);

  const list = document.getElementById("district-list");
  list.innerHTML = "";

  if (data.districts && data.districts.length) {
    data.districts.forEach(d => {
      const el = document.createElement("div");
      el.className = `district-badge d-${d.status}`;
      el.innerText = d.name;
      list.appendChild(el);
    });
  } else {
    list.innerHTML = "<span style='color:#666'>İlçe verisi yok</span>";
  }

  document.querySelectorAll("path").forEach(p => p.classList.remove("active-selection"));
  document.getElementById(id)?.classList.add("active-selection");
}

/* ====== NEWS ====== */
function loadNews() {
  const feed = document.getElementById("news-feed");
  feed.innerHTML = "";
  getNews().forEach(n => {
    const d = document.createElement("div");
    d.className = "news-item";
    d.innerHTML = `<span class="news-time">${n.time}</span>${n.text}`;
    feed.appendChild(d);
  });
}

/* ====== CITIZEN SEARCH ====== */
function searchCitizen() {
  const code = document.getElementById("citizen-search-input").value.trim();
  const box = document.getElementById("citizen-result");
  const citizen = getCitizens().find(c => c.code === code);

  box.style.display = "block";

  if (!citizen) {
    box.innerHTML = "<span style='color:#dc2626'>Kayıt bulunamadı</span>";
    return;
  }

  box.innerHTML = `
    <strong>${citizen.name} ${citizen.surname}</strong><br>
    <small>${citizen.job} | Yaş ${citizen.age}</small><br>
    <span>Durum: ${citizen.status}</span><br>
    <small>Son Konum: ${citizen.city}</small>
  `;

  const map = { "İSTANBUL":"34", "ANKARA":"06", "İZMİR":"35" };
  if (map[citizen.city]) selectCity(map[citizen.city]);
}

/* ====== TOOLTIP ====== */
const tooltip = document.getElementById("tooltip");
function showTooltip(e, name, status) {
  tooltip.style.display = "block";
  tooltip.innerHTML = `<strong>${name}</strong><br>${STATUS_LABELS[status]}`;
  moveTooltip(e);
}
function moveTooltip(e) {
  tooltip.style.left = e.clientX + 15 + "px";
  tooltip.style.top = e.clientY + 15 + "px";
}
function hideTooltip() {
  tooltip.style.display = "none";
}
</script>

</body>
</html>
