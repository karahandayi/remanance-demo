/* ================== VERİ TABANI ================== */
const DEFAULT_CITIES = {
  "34": {name:"İSTANBUL", status:"total", population:15000000},
  "06": {name:"ANKARA", status:"total", population:5500000},
  "35": {name:"İZMİR", status:"active", population:4300000}
};

const DEFAULT_NEWS = [
  {id:1, text:"İstanbul karantinası çöktü"},
  {id:2, text:"Ankara'da askeri kontrol sağlandı"}
];

function initDB(){
  if(!localStorage.cities) localStorage.cities = JSON.stringify(DEFAULT_CITIES);
  if(!localStorage.news) localStorage.news = JSON.stringify(DEFAULT_NEWS);
  if(!localStorage.citizens) localStorage.citizens = "[]";
}
initDB();

function getCities(){ return JSON.parse(localStorage.cities); }
function getNews(){ return JSON.parse(localStorage.news); }
function getCitizens(){ return JSON.parse(localStorage.citizens); }

/* ================== HARİTA ================== */
const PATHS = {
  "34":"M 180 90 L 240 90 L 230 140 L 170 130 Z",
  "06":"M 300 130 L 360 130 L 350 190 L 290 180 Z",
  "35":"M 140 190 L 190 190 L 180 240 L 130 230 Z"
};

function renderMap(){
  const svg = document.getElementById("turkey-map");
  svg.innerHTML = "";

  const cities = getCities();

  Object.keys(PATHS).forEach(id=>{
    const p = document.createElementNS("http://www.w3.org/2000/svg","path");
    p.setAttribute("d", PATHS[id]);
    p.classList.add("status-"+cities[id].status);
    p.onclick = ()=>selectCity(id);
    svg.appendChild(p);
  });
}

/* ================== UI ================== */
function selectCity(id){
  const c = getCities()[id];
  document.getElementById("city-info").style.display="block";
  document.getElementById("cityName").innerText = c.name;
  document.getElementById("cityStatus").innerText = c.status.toUpperCase();
  document.getElementById("cityPop").innerText = c.population.toLocaleString();
}

function loadNews(){
  const box = document.getElementById("news");
  box.innerHTML="";
  getNews().forEach(n=>{
    const d=document.createElement("div");
    d.className="news-item";
    d.innerText=n.text;
    box.appendChild(d);
  });
}

function searchCitizen(){
  const code = document.getElementById("citizenInput").value;
  const res = document.getElementById("citizenResult");
  const c = getCitizens().find(x=>x.code===code);
  res.innerHTML = c ? `${c.name} ${c.surname} – ${c.city}` : "Kayıt bulunamadı";
}

/* ================== SİMÜLASYON ================== */
setInterval(()=>{
  const cities = getCities();
  Object.values(cities).forEach(c=>{
    if(c.status!=="safe"){
      c.population = Math.max(0, Math.floor(c.population*0.999));
    }
  });
  localStorage.cities = JSON.stringify(cities);
},10000);
